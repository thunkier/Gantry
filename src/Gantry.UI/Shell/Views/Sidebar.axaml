<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:Gantry.UI.Shell.ViewModels"
             xmlns:collections="clr-namespace:Gantry.UI.Features.Collections.ViewModels"
             xmlns:collectionvm="clr-namespace:Gantry.UI.Features.Collections.ViewModels"
             xmlns:scvm="clr-namespace:Gantry.UI.Features.SourceControl.ViewModels"
             xmlns:scviews="clr-namespace:Gantry.UI.Features.SourceControl.Views"
             xmlns:converters="clr-namespace:Gantry.UI.Common.Converters"
             x:Class="Gantry.UI.Shell.Views.Sidebar"
             x:Name="SidebarRoot"
             x:DataType="vm:SidebarViewModel">

    <UserControl.Styles>
        <Style Selector="Button.sidebar-btn">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="2,0,0,0" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="Padding" Value="10" />
            <Setter Property="CornerRadius" Value="0" />
            <Setter Property="Foreground" Value="#C5C5C5" />
        </Style>
        <Style Selector="Button.sidebar-btn:pointerover">
            <Setter Property="Background" Value="#2A2D2E" />
            <Setter Property="Foreground" Value="#E0E0E0" />
        </Style>
        <Style Selector="Button.sidebar-btn.active">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderBrush" Value="#007ACC" />
        </Style>
        <Style Selector="Button.sidebar-btn PathIcon">
            <Setter Property="Foreground" Value="{Binding $parent[Button].Foreground}" />
        </Style>
    </UserControl.Styles>

    <Grid ColumnDefinitions="48, Auto">

        <Border Grid.Column="0" Background="#252526" BorderThickness="0,0,1,0" BorderBrush="#3E3E42">
            <StackPanel Spacing="0" Margin="0,8">
                <Button Command="{Binding ShowCollectionsCommand}" Classes="sidebar-btn" Classes.active="{Binding IsCollectionsSelected}" ToolTip.Tip="Collections">
                    <PathIcon Data="M3 3h8v8H3V3m10 0h8v8h-8V3M3 13h8v8H3v-8m10 0h8v8h-8v-8z" Width="20" Height="20"/>
                </Button>
                <Button Command="{Binding ShowHistoryCommand}" Classes="sidebar-btn" Classes.active="{Binding IsHistorySelected}" ToolTip.Tip="History">
                    <PathIcon Data="M13.5,8H12V13L16.28,15.54L17,14.33L13.5,12.25V8M13,3A9,9 0 0,0 4,12H1L4.96,16.03L9,12H6A7,7 0 0,1 13,5A7,7 0 0,1 20,12A7,7 0 0,1 13,19C11.07,19 9.32,18.21 8.06,16.94L6.64,18.36C8.27,20 10.5,21 13,21A9,9 0 0,0 22,12A9,9 0 0,0 13,3" Width="20" Height="20"/>
                </Button>
                <Button Command="{Binding ShowSourceControlCommand}" Classes="sidebar-btn" Classes.active="{Binding IsSourceControlSelected}" ToolTip.Tip="Source Control">
                    <PathIcon Data="M2.6,10.59L8.38,4.8L10.07,6.5C9.83,7.35 10.22,8.28 11,8.73V14.27C10.4,14.61 10,15.26 10,16A2,2 0 0,0 12,18A2,2 0 0,0 14,16C14,15.26 13.6,14.61 13,14.27V9.41L15.07,11.5C15,11.65 15,11.82 15,12A2,2 0 0,0 17,14A2,2 0 0,0 19,12A2,2 0 0,0 17,10C16.82,10 16.65,10 16.5,10.07L13.93,7.5C14.19,6.57 13.71,5.55 12.78,5.16C12.35,5 11.9,4.96 11.5,5.07L9.8,3.38L10.59,2.6C11.37,1.81 12.63,1.81 13.41,2.6L21.4,10.59C22.19,11.37 22.19,12.63 21.4,13.41L13.41,21.4C12.63,22.19 11.37,22.19 10.59,21.4L2.6,13.41C1.81,12.63 1.81,11.37 2.6,10.59Z" Width="20" Height="20"/>
                </Button>
                <Button Command="{Binding ShowNodeEditorCommand}" Classes="sidebar-btn" Classes.active="{Binding IsNodeEditorSelected}" ToolTip.Tip="Node Editor">
                    <PathIcon Data="M9,2V8H11V11H5C3.89,11 3,11.89 3,13V16H1V22H7V16H5V13H11V16H9V22H15V16H13V13H19V16H17V22H23V16H21V13C21,11.89 20.11,11 19,11H13V8H15V2H9Z" Width="20" Height="20"/>
                </Button>
            </StackPanel>
        </Border>

        <Grid Grid.Column="1" IsVisible="{Binding IsPaneOpen}">
            
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="{Binding SidebarWidth, Mode=TwoWay}" MinWidth="170" MaxWidth="600" />
                <ColumnDefinition Width="4" />
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0" RowDefinitions="Auto, *" Background="#1E1E1E">
                
                <Grid Grid.Row="0" ColumnDefinitions="*, Auto, Auto" Margin="12,8" IsVisible="{Binding IsCollectionsSelected}">
                    <TextBlock Grid.Column="0" Text="COLLECTIONS" FontWeight="SemiBold" FontSize="11" Foreground="#CCCCCC" VerticalAlignment="Center" />
                    <Button Grid.Column="1" Command="{Binding ImportCollectionCommand}" Content="Import" Padding="6,3" Margin="0,0,4,0" ToolTip.Tip="Import Collection" FontSize="11" Background="#2D2D30" Foreground="#CCCCCC" BorderThickness="0" CornerRadius="2" />
                    <Button Grid.Column="2" Command="{Binding AddCollectionCommand}" Content="+" Padding="6,3" ToolTip.Tip="New Collection" FontSize="14" Background="#2D2D30" Foreground="#CCCCCC" BorderThickness="0" CornerRadius="2" />
                </Grid>

                <TreeView Grid.Row="1" ItemsSource="{Binding Collections}" SelectedItem="{Binding SelectedItem}" Background="Transparent" IsVisible="{Binding IsCollectionsSelected}" Margin="0" Padding="0">
                    <TreeView.Styles>
                        <Style Selector="TreeViewItem">
                            <Setter Property="MinHeight" Value="22" />
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0" />
                            <Setter Property="FontSize" Value="13" />
                        </Style>
                        <Style Selector="TreeViewItem /template/ ToggleButton#PART_ExpandCollapseChevron">
                            <Setter Property="Margin" Value="-4,0,0,0" />
                        </Style>
                        <Style Selector="TreeViewItem:selected /template/ Border#SelectionBorder">
                            <Setter Property="Background" Value="#37373D" />
                        </Style>
                    </TreeView.Styles>
                    <TreeView.DataTemplates>
                        <TreeDataTemplate DataType="collections:CollectionViewModel" ItemsSource="{Binding Children}">
                            <Grid Background="Transparent" Height="22" ColumnDefinitions="Auto,*" DragDrop.AllowDrop="True" PointerPressed="OnPointerPressed">
                                <Interaction.Behaviors>
                                    <EventTriggerBehavior EventName="DoubleTapped">
                                        <InvokeCommandAction Command="{Binding #SidebarRoot.DataContext.OpenCollectionCommand}" CommandParameter="{Binding}" />
                                    </EventTriggerBehavior>
                                </Interaction.Behaviors>
                                <Grid.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="New Request" Command="{Binding #SidebarRoot.DataContext.AddRequestCommand}" CommandParameter="{Binding}" />
                                        <MenuItem Header="New Folder" Command="{Binding #SidebarRoot.DataContext.AddFolderCommand}" CommandParameter="{Binding}" />
                                        <Separator />
                                        <MenuItem Header="Rename" Command="{Binding #SidebarRoot.DataContext.RenameItemCommand}" CommandParameter="{Binding}" />
                                        <MenuItem Header="Delete" Command="{Binding #SidebarRoot.DataContext.DeleteItemCommand}" CommandParameter="{Binding}" />
                                        <Separator />
                                        <MenuItem Header="Export..." Command="{Binding #SidebarRoot.DataContext.ExportCollectionCommand}" CommandParameter="{Binding}" />
                                    </ContextMenu>
                                </Grid.ContextMenu>
                                <StackPanel Grid.Column="0" Grid.ColumnSpan="2" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center" Margin="-8,0,0,0">
                                    <PathIcon Data="{Binding IsRoot, Converter={x:Static converters:BoolToIconConverter.Instance}}" Foreground="#C5C5C5" Width="14" Height="14" VerticalAlignment="Center" />
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center" IsVisible="{Binding !IsEditing}" Foreground="#CCCCCC" />
                                    <TextBox Text="{Binding EditableName}" VerticalAlignment="Center" IsVisible="{Binding IsEditing}" MinWidth="100" Padding="2,0" MinHeight="18" FontSize="13" Watermark="Name..." LostFocus="OnTextBoxLostFocus" AttachedToVisualTree="OnTextBoxAttached" />
                                </StackPanel>
                            </Grid>
                        </TreeDataTemplate>
                        <DataTemplate DataType="collectionvm:RequestItemViewModel">
                            <StackPanel Orientation="Horizontal" Spacing="8" Background="Transparent" PointerPressed="OnPointerPressed" Margin="-40,0,0,0">
                                <StackPanel.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Rename" Command="{Binding #SidebarRoot.DataContext.RenameItemCommand}" CommandParameter="{Binding}" />
                                        <MenuItem Header="Delete" Command="{Binding #SidebarRoot.DataContext.DeleteItemCommand}" CommandParameter="{Binding}" />
                                    </ContextMenu>
                                </StackPanel.ContextMenu>
                                <TextBlock Text="{Binding Method}" Foreground="{Binding MethodColor}" FontWeight="SemiBold" FontSize="10" MinWidth="35" TextAlignment="Right" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" IsVisible="{Binding !IsEditing}" Foreground="#CCCCCC" />
                                <TextBox Text="{Binding EditableName}" VerticalAlignment="Center" IsVisible="{Binding IsEditing}" MinWidth="100" Watermark="Enter name..." LostFocus="OnTextBoxLostFocus" AttachedToVisualTree="OnTextBoxAttached" />
                            </StackPanel>
                        </DataTemplate>
                    </TreeView.DataTemplates>
                    <Interaction.Behaviors>
                        <EventTriggerBehavior EventName="DoubleTapped">
                            <InvokeCommandAction Command="{Binding OpenRequestCommand}" CommandParameter="{Binding SelectedItem}" />
                        </EventTriggerBehavior>
                    </Interaction.Behaviors>
                </TreeView>

                <Grid Grid.Row="0" Margin="12,8" IsVisible="{Binding IsHistorySelected}">
                    <TextBlock Text="HISTORY" FontWeight="SemiBold" FontSize="11" Foreground="#CCCCCC" />
                </Grid>
                <TextBlock Grid.Row="1" Text="History coming soon..." Margin="12" IsVisible="{Binding IsHistorySelected}" Foreground="#858585" FontSize="12" />

                <ContentControl Grid.Row="0" Grid.RowSpan="2" Content="{Binding SourceControl}" IsVisible="{Binding IsSourceControlSelected}">
                    <ContentControl.DataTemplates>
                        <DataTemplate DataType="scvm:SourceControlViewModel">
                            <scviews:SCView />
                        </DataTemplate>
                    </ContentControl.DataTemplates>
                </ContentControl>

                <Grid Grid.Row="0" Margin="12,8" IsVisible="{Binding IsNodeEditorSelected}">
                    <Grid ColumnDefinitions="*, Auto">
                        <TextBlock Grid.Column="0" Text="NODE TASKS" FontWeight="SemiBold" FontSize="11" Foreground="#CCCCCC" VerticalAlignment="Center"/>
                        <Button Grid.Column="1" Command="{Binding AddTaskCommand}" Content="+" Padding="6,3" ToolTip.Tip="New Task" FontSize="14" Background="#2D2D30" Foreground="#CCCCCC" BorderThickness="0" CornerRadius="2">
                            <Button.Styles>
                                <Style Selector="Button:pointerover">
                                    <Setter Property="Background" Value="#3E3E42" />
                                </Style>
                            </Button.Styles>
                        </Button>
                    </Grid>
                </Grid>
                <ListBox Grid.Row="1" ItemsSource="{Binding NodeTasks}" Background="Transparent" IsVisible="{Binding IsNodeEditorSelected}" Margin="4,0,0,0">
                    <ListBox.Styles>
                        <Style Selector="ListBoxItem">
                            <Setter Property="Padding" Value="8,4" />
                        </Style>
                        <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                            <Setter Property="Background" Value="#37373D" />
                        </Style>
                        <Style Selector="ListBoxItem:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="#2A2D2E" />
                        </Style>
                    </ListBox.Styles>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="8" Background="Transparent">
                                <Interaction.Behaviors>
                                    <EventTriggerBehavior EventName="DoubleTapped">
                                        <InvokeCommandAction Command="{Binding #SidebarRoot.DataContext.OpenTaskCommand}" CommandParameter="{Binding}" />
                                    </EventTriggerBehavior>
                                </Interaction.Behaviors>
                                <PathIcon Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" Foreground="#C5C5C5" Width="14" Height="14" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Foreground="#CCCCCC"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>

            <Border Grid.Column="1" 
                    Name="ResizeHandle"
                    Background="#3E3E42" 
                    Width="4" 
                    VerticalAlignment="Stretch" 
                    Cursor="SizeWestEast"
                    PointerPressed="OnResizeHandlePointerPressed"
                    PointerMoved="OnResizeHandlePointerMoved"
                    PointerReleased="OnResizeHandlePointerReleased" />
        </Grid>
    </Grid>
</UserControl>