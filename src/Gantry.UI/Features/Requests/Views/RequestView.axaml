<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Gantry.UI.Features.Requests.ViewModels"
             xmlns:ui="clr-namespace:Gantry.UI"
             xmlns:cv="clr-namespace:Gantry.UI.Common.Converters"
             xmlns:ae="clr-namespace:AvaloniaEdit;assembly=AvaloniaEdit"
             xmlns:views="clr-namespace:Gantry.UI.Features.Requests.Views"
             xmlns:adc="clr-namespace:Avalonia.Data.Converters;assembly=Avalonia.Base"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="Gantry.UI.Features.Requests.Views.RequestView"
             x:DataType="vm:RequestViewModel"
             x:Name="Root">

  <UserControl.DataTemplates>
      <DataTemplate DataType="{x:Type vm:ResponseViewModel}">
          <views:ResponseView />
      </DataTemplate>
  </UserControl.DataTemplates>

  <UserControl.Resources>
      <cv:EnumEqualityConverter x:Key="EnumEqualityConverter" />
      <cv:BoolToBrushConverter x:Key="BoolToBrushConverter" />
  </UserControl.Resources>

  <UserControl.KeyBindings>
      <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveCommand}" />
  </UserControl.KeyBindings>

  <Grid RowDefinitions="Auto, *, 5, *">
    <!-- Top Bar: Method, URL, Send -->
    <!-- Top Bar: Method, URL, Save, Send, Settings -->
    <Grid Grid.Row="0" ColumnDefinitions="Auto, *, Auto, Auto, Auto" Margin="10">
      <ComboBox Grid.Column="0" ItemsSource="{Binding Methods}" SelectedItem="{Binding SelectedMethod}" MinWidth="100" />
      
      <!-- URL Box with Border -->
      <Border Grid.Column="1" BorderBrush="Gray" BorderThickness="1" Margin="10,0" CornerRadius="3">
          <ae:TextEditor Name="UrlEditor"
                         Document="{Binding Url, Converter={x:Static cv:StringToTextDocumentConverter.Instance}}" 
                         Margin="5,2" 
                         Height="20"
                         FontFamily="Cascadia Code,Consolas,Monospace"
                         ShowLineNumbers="False"
                         VerticalScrollBarVisibility="Hidden"
                         HorizontalScrollBarVisibility="Hidden" />
      </Border>

      <Button Grid.Column="2" Command="{Binding SaveCommand}" Content="Save" Margin="0,0,5,0" />
      <Button Grid.Column="3" Command="{Binding SendRequestCommand}" Content="Send" IsEnabled="{Binding !IsLoading}" Margin="0,0,5,0" />
      <Button Grid.Column="4" Command="{Binding ToggleHistoryCommand}" Content="History" Margin="0,0,5,0" 
              IsVisible="{Binding !IsHistoryVisible}" ToolTip.Tip="Show History"/>
    </Grid>

    <!-- Tabs for Request Details -->
    <TabControl Grid.Row="1" Margin="10,0,10,0">
      <TabItem Header="Params">
        <DataGrid ItemsSource="{Binding Params}" AutoGenerateColumns="False">
            <DataGrid.Columns>
                <DataGridCheckBoxColumn Header="Active" Binding="{Binding IsActive}"/>
                <DataGridTextColumn Header="Key" Binding="{Binding Key}"/>
                <DataGridTextColumn Header="Value" Binding="{Binding Value}"/>
                <DataGridTextColumn Header="Description" Binding="{Binding Description}"/>
            </DataGrid.Columns>
        </DataGrid>
      </TabItem>
      
      <TabItem Header="Authorization">
          <StackPanel Spacing="10" Margin="10" MaxWidth="600" HorizontalAlignment="Left">
              <TextBlock Text="Type" FontWeight="Bold" />
              <ComboBox ItemsSource="{Binding AuthTypes}" SelectedItem="{Binding Auth.Type}" MinWidth="200" />
              
              <!-- Inherit -->
              <TextBlock Text="Inheriting authorization from parent collection." 
                         IsVisible="{Binding Auth.Type, Converter={StaticResource EnumEqualityConverter}, ConverterParameter=Inherit}"
                         FontStyle="Italic" Opacity="0.7" />

              <!-- Bearer Token -->
              <StackPanel IsVisible="{Binding Auth.Type, Converter={StaticResource EnumEqualityConverter}, ConverterParameter=BearerToken}" Spacing="5">
                  <TextBlock Text="Token" />
                  <Border BorderBrush="Gray" BorderThickness="1" CornerRadius="3">
                      <ae:TextEditor Document="{Binding Auth.Token, Converter={x:Static cv:StringToTextDocumentConverter.Instance}}" 
                                     Height="20"
                                     FontFamily="Cascadia Code,Consolas,Monospace"
                                     ShowLineNumbers="False"
                                     VerticalScrollBarVisibility="Hidden"
                                     HorizontalScrollBarVisibility="Hidden" />
                  </Border>
              </StackPanel>
              
              <!-- Basic Auth -->
              <StackPanel IsVisible="{Binding Auth.Type, Converter={StaticResource EnumEqualityConverter}, ConverterParameter=Basic}" Spacing="5">
                  <TextBlock Text="Username" />
                  <Border BorderBrush="Gray" BorderThickness="1" CornerRadius="3">
                      <ae:TextEditor Document="{Binding Auth.Username, Converter={x:Static cv:StringToTextDocumentConverter.Instance}}" 
                                     Height="20"
                                     FontFamily="Cascadia Code,Consolas,Monospace"
                                     ShowLineNumbers="False"
                                     VerticalScrollBarVisibility="Hidden"
                                     HorizontalScrollBarVisibility="Hidden" />
                  </Border>
                  <TextBlock Text="Password" />
                  <Border BorderBrush="Gray" BorderThickness="1" CornerRadius="3">
                      <ae:TextEditor Document="{Binding Auth.Password, Converter={x:Static cv:StringToTextDocumentConverter.Instance}}" 
                                     Height="20"
                                     FontFamily="Cascadia Code,Consolas,Monospace"
                                     ShowLineNumbers="False"
                                     VerticalScrollBarVisibility="Hidden"
                                     HorizontalScrollBarVisibility="Hidden" />
                  </Border>
              </StackPanel>
          </StackPanel>
      </TabItem>
      
      <TabItem Header="Headers">
        <DataGrid ItemsSource="{Binding Headers}" AutoGenerateColumns="False">
            <DataGrid.Columns>
                <DataGridCheckBoxColumn Header="Active" Binding="{Binding IsActive}"/>
                <DataGridTextColumn Header="Key" Binding="{Binding Key}"/>
                <DataGridTextColumn Header="Value" Binding="{Binding Value}"/>
                <DataGridTextColumn Header="Description" Binding="{Binding Description}"/>
            </DataGrid.Columns>
        </DataGrid>
      </TabItem>
      
      <TabItem Header="Body">
        <ae:TextEditor Document="{Binding Body, Converter={x:Static cv:StringToTextDocumentConverter.Instance}}" 
                       ShowLineNumbers="True"
                       FontFamily="Cascadia Code,Consolas,Monospace" />
      </TabItem>
      
      <TabItem Header="Scripts">
          <Grid RowDefinitions="*, *" ColumnDefinitions="*, *" Margin="10">
              <Grid Grid.Row="0" Grid.Column="0" RowDefinitions="Auto, *" Margin="0,0,5,5">
                  <TextBlock Text="Pre-request Script" FontWeight="Bold" Margin="0,0,0,5" />
                  <TextBox Text="{Binding Scripts.PreRequestScript}" AcceptsReturn="True" FontFamily="Consolas,Courier New,monospace" />
              </Grid>
              <Grid Grid.Row="0" Grid.Column="1" RowDefinitions="Auto, *" Margin="5,0,0,5">
                  <TextBlock Text="Post-response Script" FontWeight="Bold" Margin="0,0,0,5" />
                  <TextBox Text="{Binding Scripts.PostResponseScript}" AcceptsReturn="True" FontFamily="Consolas,Courier New,monospace" />
              </Grid>
          </Grid>
      </TabItem>
    </TabControl>

    <!-- Splitter -->
    <GridSplitter Grid.Row="2" Background="Gray" ResizeDirection="Rows" IsVisible="{Binding Response, Converter={x:Static adc:ObjectConverters.IsNotNull}}" />

    <!-- Response View -->
    <!-- Response Area -->
    <Grid Grid.Row="3" Margin="10,0,10,10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250" MinWidth="150" MaxWidth="500"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- History List -->
        <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="0,0,1,0" Margin="0,0,5,0" IsVisible="{Binding IsHistoryVisible}">
            <Grid RowDefinitions="Auto, *">
                <Grid Grid.Row="0" ColumnDefinitions="*, Auto" Margin="0,0,5,5">
                    <TextBlock Grid.Column="0" Text="History" FontWeight="Bold" VerticalAlignment="Center"/>
                    <Button Grid.Column="1" Command="{Binding ToggleHistoryCommand}" Content="âœ•" 
                            Background="Transparent" BorderThickness="0" Padding="5,0" ToolTip.Tip="Hide History"/>
                </Grid>
                <ListBox Grid.Row="1" ItemsSource="{Binding History}" SelectedItem="{Binding SelectedHistoryItem}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Spacing="2">
                                <StackPanel Orientation="Horizontal" Spacing="5">
                                    <TextBlock Text="{Binding StatusCode}" FontWeight="Bold" 
                                               Foreground="{Binding IsSuccess, Converter={StaticResource BoolToBrushConverter}}"/>
                                    <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm:ss'}" Opacity="0.7" FontSize="11" VerticalAlignment="Center"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Spacing="5" Opacity="0.7" TextElement.FontSize="11">
                                    <TextBlock Text="{Binding Duration}"/>
                                    <TextBlock Text="{Binding Size}"/>
                                </StackPanel>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!-- Splitter -->
        <GridSplitter Grid.Column="1" Width="5" ResizeBehavior="PreviousAndNext" Background="Transparent" IsVisible="{Binding IsHistoryVisible}"/>

        <!-- Response View -->
        <ContentControl Grid.Column="2" Content="{Binding Response}" />
    </Grid>
  </Grid>
</UserControl>
