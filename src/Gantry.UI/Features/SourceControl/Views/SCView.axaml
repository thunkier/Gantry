<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Gantry.UI.Features.SourceControl.ViewModels"
             xmlns:cv="clr-namespace:Gantry.UI.Common.Converters"
             mc:Ignorable="d" d:DesignWidth="300" d:DesignHeight="600"
             x:Class="Gantry.UI.Features.SourceControl.Views.SCView"
             x:DataType="vm:SourceControlViewModel">
    
    <UserControl.Resources>
        <cv:GitStatusToIconConverter x:Key="GitStatusToIconConverter" />
        <cv:GitStatusToColorConverter x:Key="GitStatusToColorConverter" />
        <cv:BoolToBackgroundConverter x:Key="BoolToBackgroundConverter" />
        <cv:BoolToFontWeightConverter x:Key="BoolToFontWeightConverter" />

        <!-- Flyout for adding remote -->
        <Flyout x:Key="RemoteFlyout">
            <StackPanel Spacing="10" Width="250">
                <TextBlock Text="Add Remote" FontWeight="Bold" />
                <TextBox Text="{Binding RemoteName}" Watermark="Name (origin)" />
                <TextBox Text="{Binding RemoteUrl}" Watermark="URL" />
                <Button Command="{Binding AddRemoteCommand}" Content="Add Remote" HorizontalAlignment="Stretch" />
            </StackPanel>
        </Flyout>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto, Auto, *, Auto">
        <!-- Title -->
        <TextBlock Grid.Row="0" Text="Source Control" FontWeight="Bold" FontSize="14" Margin="10,10,10,5" />

        <!-- Status Message -->
        <Border Grid.Row="1" Background="#2C2C2C" Padding="8,4" Margin="10,0" 
                IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <TextBlock Text="{Binding StatusMessage}" FontSize="11" TextWrapping="Wrap" />
        </Border>

        <!-- No Git Repo State -->
        <StackPanel Grid.Row="2" Margin="10" Spacing="10" IsVisible="{Binding !IsGitRepo}">
            <TextBlock Text="No Git repository found." TextWrapping="Wrap" />
            <Button Command="{Binding InitializeRepoCommand}" Content="Initialize Repository" HorizontalAlignment="Stretch" />
        </StackPanel>

        <!-- Git Repo Content -->
        <TabControl Grid.Row="2" Margin="10,5" IsVisible="{Binding IsGitRepo}" SelectedIndex="{Binding SelectedTabIndex}">
            
            <!-- CHANGES TAB -->
            <TabItem Header="Changes">
                <Grid RowDefinitions="Auto, *, Auto">
                    <!-- Toolbar -->
                    <StackPanel Grid.Row="0" Spacing="5" Margin="0,5,0,10">
                        <Grid ColumnDefinitions="*,*,*">
                            <Button Grid.Column="0" Command="{Binding PullCommand}" Content="Pull" 
                                    HorizontalAlignment="Stretch" Margin="0,0,2,0" FontSize="11" Padding="4" />
                            <Button Grid.Column="1" Command="{Binding PushCommand}" Content="Push" 
                                    HorizontalAlignment="Stretch" Margin="2,0" FontSize="11" Padding="4" />
                            <Button Grid.Column="2" Command="{Binding FetchCommand}" Content="Fetch" 
                                    HorizontalAlignment="Stretch" Margin="2,0,0,0" FontSize="11" Padding="4" />
                        </Grid>
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Grid.Column="0" Text="{Binding CurrentBranch, StringFormat='Branch: {0}'}" 
                                       VerticalAlignment="Center" FontSize="11" />
                            <Button Grid.Column="1" Flyout="{StaticResource RemoteFlyout}" Content="Remote" 
                                    FontSize="11" Padding="4,2" />
                        </Grid>
                    </StackPanel>

                    <!-- File Lists and Diff -->
                    <ScrollViewer Grid.Row="1">
                        <StackPanel Spacing="10">
                            <!-- Unstaged Changes -->
                            <StackPanel Spacing="5">
                                <Grid ColumnDefinitions="*, Auto">
                                    <TextBlock Grid.Column="0" Text="Unstaged Changes" FontWeight="SemiBold" FontSize="12" />
                                    <Button Grid.Column="1" Command="{Binding StageAllCommand}" Content="Stage All" 
                                            FontSize="10" Padding="4,2" />
                                </Grid>
                                <Border BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="4" MinHeight="80">
                                    <ItemsControl ItemsSource="{Binding UnstagedFiles}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Padding="4,2" Background="Transparent" PointerPressed="OnFileClick">
                                                    <Grid ColumnDefinitions="Auto, *">
                                                        <TextBlock Grid.Column="0" 
                                                                   Text="{Binding Status, Converter={StaticResource GitStatusToIconConverter}}" 
                                                                   Foreground="{Binding Status, Converter={StaticResource GitStatusToColorConverter}}"
                                                                   FontWeight="Bold" Margin="0,0,8,0" FontSize="11" />
                                                        <TextBlock Grid.Column="1" Text="{Binding FilePath}" FontSize="11" />
                                                    </Grid>
                                                    <Border.ContextMenu>
                                                        <ContextMenu>
                                                            <MenuItem Header="Stage" Command="{Binding $parent[UserControl].((vm:SourceControlViewModel)DataContext).StageFileCommand}" CommandParameter="{Binding}" />
                                                            <MenuItem Header="Discard Changes" Command="{Binding $parent[UserControl].((vm:SourceControlViewModel)DataContext).DiscardChangesCommand}" CommandParameter="{Binding}" />
                                                        </ContextMenu>
                                                    </Border.ContextMenu>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Border>
                            </StackPanel>

                            <!-- Staged Changes -->
                            <StackPanel Spacing="5">
                                <Grid ColumnDefinitions="*, Auto">
                                    <TextBlock Grid.Column="0" Text="Staged Changes" FontWeight="SemiBold" FontSize="12" />
                                    <Button Grid.Column="1" Command="{Binding UnstageAllCommand}" Content="Unstage All" 
                                            FontSize="10" Padding="4,2" />
                                </Grid>
                                <Border BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="4" MinHeight="80">
                                    <ItemsControl ItemsSource="{Binding StagedFiles}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Padding="4,2" Background="Transparent" PointerPressed="OnFileClick">
                                                    <Grid ColumnDefinitions="Auto, *">
                                                        <TextBlock Grid.Column="0" 
                                                                   Text="{Binding Status, Converter={StaticResource GitStatusToIconConverter}}" 
                                                                   Foreground="{Binding Status, Converter={StaticResource GitStatusToColorConverter}}"
                                                                   FontWeight="Bold" Margin="0,0,8,0" FontSize="11" />
                                                        <TextBlock Grid.Column="1" Text="{Binding FilePath}" FontSize="11" />
                                                    </Grid>
                                                    <Border.ContextMenu>
                                                        <ContextMenu>
                                                            <MenuItem Header="Unstage" Command="{Binding $parent[UserControl].((vm:SourceControlViewModel)DataContext).UnstageFileCommand}" CommandParameter="{Binding}" />
                                                        </ContextMenu>
                                                    </Border.ContextMenu>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Border>
                            </StackPanel>

                            <!-- Diff Viewer -->
                            <StackPanel Spacing="5" IsVisible="{Binding SelectedFile, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <TextBlock Text="Diff" FontWeight="SemiBold" FontSize="12" />
                                <Border BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="8" MaxHeight="200">
                                    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                                        <TextBlock Text="{Binding FileDiff}" FontFamily="Consolas,Courier New,monospace" 
                                                   FontSize="10" TextWrapping="NoWrap" />
                                    </ScrollViewer>
                                </Border>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Commit Section -->
                    <StackPanel Grid.Row="2" Spacing="5" Margin="0,10,0,0">
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBlock Grid.Column="0" Text="Commit Message" FontWeight="SemiBold" FontSize="12" />
                            <TextBlock Grid.Column="1" Text="{Binding CommitMessageLength}" FontSize="10" Opacity="0.7" />
                        </Grid>
                        <TextBox Text="{Binding CommitMessage}" Watermark="Message (Ctrl+Enter to commit)" 
                                 Height="60" AcceptsReturn="True" TextWrapping="Wrap" />
                        <Button Command="{Binding CommitCommand}" Content="Commit" HorizontalAlignment="Stretch" />
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- HISTORY TAB -->
            <TabItem Header="History">
                <Grid RowDefinitions="Auto, *">
                    <Button Grid.Row="0" Command="{Binding RefreshStatusCommand}" Content="Refresh" 
                            HorizontalAlignment="Right" Margin="0,5" FontSize="11" Padding="8,4" />
                    <ScrollViewer Grid.Row="1">
                        <ItemsControl ItemsSource="{Binding CommitHistory}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="8" Margin="0,4" Background="#2C2C2C" CornerRadius="4">
                                        <StackPanel Spacing="4">
                                            <Grid ColumnDefinitions="Auto, *">
                                                <TextBlock Grid.Column="0" Text="{Binding ShortSha}" FontFamily="Consolas" 
                                                           FontSize="10" Foreground="#569CD6" Margin="0,0,8,0" />
                                                <TextBlock Grid.Column="1" Text="{Binding Date, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" 
                                                           FontSize="10" Opacity="0.7" />
                                            </Grid>
                                            <TextBlock Text="{Binding ShortMessage}" FontWeight="SemiBold" FontSize="11" TextWrapping="Wrap" />
                                            <TextBlock Text="{Binding Author}" FontSize="10" Opacity="0.7" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </TabItem>

            <!-- BRANCHES TAB -->
            <TabItem Header="Branches">
                <Grid RowDefinitions="Auto, *, Auto">
                    <!-- Create Branch -->
                    <StackPanel Grid.Row="0" Spacing="5" Margin="0,5,0,10">
                        <TextBlock Text="Create Branch" FontWeight="SemiBold" FontSize="12" />
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBox Grid.Column="0" Text="{Binding NewBranchName}" Watermark="Branch name" Margin="0,0,5,0" />
                            <Button Grid.Column="1" Command="{Binding CreateBranchCommand}" Content="Create" Padding="8,4" />
                        </Grid>
                    </StackPanel>

                    <!-- Branch List -->
                    <ScrollViewer Grid.Row="1">
                        <ItemsControl ItemsSource="{Binding Branches}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="8,6" Margin="0,2" 
                                            Background="{Binding IsCurrent, Converter={StaticResource BoolToBackgroundConverter}}"
                                            CornerRadius="4">
                                        <Grid ColumnDefinitions="Auto, *, Auto">
                                            <TextBlock Grid.Column="0" Text="â—" Margin="0,0,8,0"
                                                       IsVisible="{Binding IsCurrent}" Foreground="#4EC9B0" />
                                            <TextBlock Grid.Column="1" Text="{Binding Name}" FontSize="11" 
                                                       FontWeight="{Binding IsCurrent, Converter={StaticResource BoolToFontWeightConverter}}" />
                                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                                                <Button Command="{Binding $parent[UserControl].((vm:SourceControlViewModel)DataContext).SwitchBranchCommand}" 
                                                        CommandParameter="{Binding}"
                                                        Content="Switch" FontSize="10" Padding="6,2"
                                                        IsVisible="{Binding !IsCurrent}" />
                                                <Button Command="{Binding $parent[UserControl].((vm:SourceControlViewModel)DataContext).DeleteBranchCommand}" 
                                                        CommandParameter="{Binding}"
                                                        Content="Delete" FontSize="10" Padding="6,2"
                                                        IsVisible="{Binding !IsCurrent}" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </TabItem>

            <!-- STASHES TAB -->
            <TabItem Header="Stashes">
                <Grid RowDefinitions="Auto, *">
                    <!-- Create Stash -->
                    <StackPanel Grid.Row="0" Spacing="5" Margin="0,5,0,10">
                        <TextBlock Text="Create Stash" FontWeight="SemiBold" FontSize="12" />
                        <Grid ColumnDefinitions="*, Auto">
                            <TextBox Grid.Column="0" Text="{Binding StashMessage}" Watermark="Stash message (optional)" Margin="0,0,5,0" />
                            <Button Grid.Column="1" Command="{Binding CreateStashCommand}" Content="Stash" Padding="8,4" />
                        </Grid>
                    </StackPanel>

                    <!-- Stash List -->
                    <ScrollViewer Grid.Row="1">
                        <ItemsControl ItemsSource="{Binding Stashes}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="8" Margin="0,4" Background="#2C2C2C" CornerRadius="4">
                                        <Grid ColumnDefinitions="*, Auto">
                                            <StackPanel Grid.Column="0" Spacing="2">
                                                <TextBlock Text="{Binding Message}" FontSize="11" FontWeight="SemiBold" />
                                                <TextBlock Text="{Binding Index, StringFormat='stash@{{{0}}}'}" 
                                                           FontFamily="Consolas" FontSize="10" Opacity="0.7" />
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Spacing="4">
                                                <Button Command="{Binding $parent[UserControl].((vm:SourceControlViewModel)DataContext).ApplyStashCommand}" 
                                                        CommandParameter="{Binding}"
                                                        Content="Apply" FontSize="10" Padding="8,4" HorizontalAlignment="Stretch" />
                                                <Button Command="{Binding $parent[UserControl].((vm:SourceControlViewModel)DataContext).PopStashCommand}" 
                                                        CommandParameter="{Binding}"
                                                        Content="Pop" FontSize="10" Padding="8,4" HorizontalAlignment="Stretch" />
                                                <Button Command="{Binding $parent[UserControl].((vm:SourceControlViewModel)DataContext).DropStashCommand}" 
                                                        CommandParameter="{Binding}"
                                                        Content="Drop" FontSize="10" Padding="8,4" HorizontalAlignment="Stretch" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Bottom Refresh Button -->
        <Button Grid.Row="3" Command="{Binding RefreshStatusCommand}" Content="Refresh Status" 
                HorizontalAlignment="Stretch" Margin="10,5,10,10" 
                IsVisible="{Binding IsGitRepo}" IsEnabled="{Binding !IsRefreshing}" />
    </Grid>
</UserControl>
